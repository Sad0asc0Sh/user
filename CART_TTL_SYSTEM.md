# سیستم مهلت سبد خرید (Cart TTL System)

## نمای کلی

این سیستم یک راهکار جامع برای مدیریت انقضای سبدهای خرید ارائه می‌دهد که شامل تنظیمات قابل تغییر در پنل ادمین، انقضای خودکار، و ابزارهای مدیریتی برای پاکسازی سبدهای رها شده است.

## ویژگی‌های کلیدی

### 1. مهلت زمانی قابل تنظیم
- مدت زمان پیش‌فرض: 1 ساعت
- محدوده قابل تنظیم: 0.5 تا 168 ساعت (30 دقیقه تا 7 روز)
- قابل تنظیم از طریق پنل ادمین در بخش تنظیمات

### 2. انقضای خودکار
- سبدهای خرید به صورت خودکار پس از مهلت تعیین شده منقضی می‌شوند
- قابل فعال/غیرفعال کردن از طریق تنظیمات

### 3. مدیریت سبدهای رها شده
- مشاهده لیست سبدهای رها شده در پنل ادمین
- حذف دستی تک‌تک سبدها
- پاکسازی انبوه سبدهای منقضی شده

## ساختار فنی

### مدل پایگاه داده (Cart Model)

```javascript
{
  // فیلدهای موجود قبلی
  user: { type: mongoose.Schema.Types.ObjectId, ref: 'User' },
  items: [...],
  totalPrice: Number,
  status: String,

  // فیلدهای جدید TTL
  expiresAt: {
    type: Date,
    index: true,  // برای کارایی بهتر در جستجوها
  },
  isExpired: {
    type: Boolean,
    default: false,
    index: true,
  },
}
```

### متدهای مدل

#### `setExpiry(hours)`
تنظیم زمان انقضا برای سبد خرید

```javascript
cart.setExpiry(hours)
// مثال: cart.setExpiry(1) - انقضا پس از 1 ساعت
```

**پارامترها:**
- `hours` (Number): تعداد ساعت تا انقضا (پیش‌فرض: 1)

**بازگشتی:**
- `Date`: تاریخ و زمان انقضا

**عملکرد:**
- محاسبه و تنظیم `expiresAt` بر اساس ساعت‌های تعیین شده
- تنظیم `isExpired` به `false`

#### `checkExpiry()`
بررسی وضعیت انقضای سبد خرید

```javascript
const expired = cart.checkExpiry()
```

**بازگشتی:**
- `Boolean`: `true` اگر سبد منقضی شده، در غیر این صورت `false`

**عملکرد:**
- مقایسه زمان فعلی با `expiresAt`
- اگر سبد منقضی شده، `isExpired` را به `true` تنظیم می‌کند

### مدل تنظیمات (Settings Model)

```javascript
{
  cartSettings: {
    cartTTLHours: {
      type: Number,
      default: 1,
      min: 0.5,
      max: 168,
    },
    autoExpireEnabled: {
      type: Boolean,
      default: true,
    },
    autoDeleteExpired: {
      type: Boolean,
      default: false,
    },
  }
}
```

## API Endpoints

### 1. حذف سبد خرید توسط ادمین

```http
DELETE /api/carts/admin/:cartId
```

**احراز هویت:** نیاز به نقش admin, manager, یا superadmin

**پارامترها:**
- `cartId`: شناسه سبد خرید

**پاسخ موفق (200):**
```json
{
  "success": true,
  "message": "سبد خرید با موفقیت حذف شد"
}
```

**پاسخ خطا (404):**
```json
{
  "success": false,
  "message": "سبد خرید یافت نشد"
}
```

### 2. پاکسازی سبدهای منقضی شده

```http
POST /api/carts/admin/cleanup
```

**احراز هویت:** نیاز به نقش admin, manager, یا superadmin

**عملکرد:**
- جستجوی تمام سبدهای فعال که `expiresAt` آن‌ها گذشته است
- علامت‌گذاری آن‌ها به عنوان منقضی شده (`isExpired: true`)
- خالی کردن آیتم‌ها و تنظیم قیمت کل به صفر
- در صورت فعال بودن `autoDeleteExpired`، حذف کامل سبد از دیتابیس

**پاسخ موفق (200):**
```json
{
  "success": true,
  "count": 15,
  "message": "15 سبد خرید منقضی شده پاکسازی شد"
}
```

## تنظیمات پنل ادمین

### دسترسی به تنظیمات
مسیر: **تنظیمات > تنظیمات سبد خرید**

فقط کاربران با نقش `manager` یا `superadmin` می‌توانند به این بخش دسترسی داشته باشند.

### فیلدهای تنظیمات

#### 1. مدت زمان نگهداری سبد خرید
- **نوع:** عدد اعشاری
- **واحد:** ساعت
- **حداقل:** 0.5 ساعت (30 دقیقه)
- **حداکثر:** 168 ساعت (7 روز)
- **پیش‌فرض:** 1 ساعت
- **گام:** 0.5 ساعت

**توصیه:** مدت زمان بین 1 تا 3 ساعت برای بهترین تجربه کاربری و مدیریت منابع سرور

#### 2. فعال‌سازی انقضای خودکار
- **نوع:** سوئیچ (فعال/غیرفعال)
- **پیش‌فرض:** فعال

اگر فعال باشد، سبدهای خرید پس از مدت تعیین شده به صورت خودکار منقضی می‌شوند.

#### 3. حذف خودکار سبدهای منقضی شده
- **نوع:** سوئیچ (فعال/غیرفعال)
- **پیش‌فرض:** غیرفعال

⚠️ **هشدار:** اگر فعال باشد، سبدهای منقضی شده به طور کامل از دیتابیس حذف می‌شوند (توصیه نمی‌شود)

**دلیل عدم توصیه:**
- از دست رفتن داده‌های تحلیلی ارزشمند
- عدم امکان بررسی تاریخچه سبدهای رها شده
- عدم امکان ارسال یادآوری به مشتریان

## صفحه سبدهای رها شده

### دسترسی
مسیر: **سفارشات > سبدهای رها شده**

### ویژگی‌ها

#### 1. نمایش اطلاعات سبد
- نام و ایمیل کاربر
- تعداد آیتم‌ها
- مجموع قیمت
- زمان آخرین فعالیت
- وضعیت انقضا

#### 2. عملیات روی سبدها

##### حذف تک‌به‌تک
```javascript
// کلیک بر روی دکمه "حذف" در هر ردیف
// نمایش دیالوگ تایید
// حذف سبد از دیتابیس
```

##### پاکسازی انبوه
```javascript
// کلیک بر روی دکمه "پاکسازی منقضی‌ها"
// نمایش دیالوگ تایید
// پاکسازی همه سبدهای منقضی شده
```

##### ارسال یادآوری
- ارسال یادآوری ایمیلی
- ارسال یادآوری پیامکی

## نحوه عملکرد سیستم

### 1. زمان ایجاد/به‌روزرسانی سبد

```javascript
// در cartController.js - addOrUpdateItem
cart.calculateTotal()
const ttlHours = await getCartTTL()  // دریافت مدت زمان از تنظیمات
cart.setExpiry(ttlHours)  // تنظیم زمان انقضا
await cart.save()
```

### 2. بررسی انقضا

سبدها به دو روش بررسی می‌شوند:

#### الف) بررسی دستی در API
```javascript
// در getMyCart یا سایر endpointها
if (cart.checkExpiry()) {
  // سبد منقضی شده - اقدامات مناسب
}
```

#### ب) پاکسازی انبوه توسط ادمین
```javascript
// در cleanupExpiredCarts
const expiredCarts = await Cart.find({
  status: 'active',
  expiresAt: { $lte: new Date() },
  isExpired: false,
})

for (const cart of expiredCarts) {
  cart.isExpired = true
  cart.items = []
  cart.totalPrice = 0
  await cart.save()
}
```

### 3. تأثیر بر تجربه کاربری

- **قبل از انقضا:** کاربر می‌تواند آیتم‌ها را در سبد نگه دارد و مشاهده کند
- **بعد از انقضا:**
  - سبد به عنوان منقضی شده علامت‌گذاری می‌شود
  - آیتم‌ها خالی می‌شوند (یا سبد حذف می‌شود اگر autoDeleteExpired فعال باشد)
  - کاربر باید مجدداً محصولات را به سبد اضافه کند

## بهینه‌سازی‌ها

### 1. Indexing
فیلدهای `expiresAt` و `isExpired` دارای index هستند برای جستجوهای سریع‌تر.

```javascript
expiresAt: {
  type: Date,
  index: true,
}
isExpired: {
  type: Boolean,
  default: false,
  index: true,
}
```

### 2. کوئری‌های بهینه

```javascript
// جستجوی سبدهای منقضی شده
Cart.find({
  status: 'active',
  expiresAt: { $lte: new Date() },
  isExpired: false,
})
```

استفاده از indexها باعث می‌شود این کوئری بسیار سریع اجرا شود حتی با تعداد زیاد سبدها.

## توصیه‌های استفاده

### 1. تنظیم مهلت مناسب
- **30 دقیقه - 1 ساعت:** برای محصولات با تقاضای بالا و موجودی محدود
- **1-3 ساعت:** پیش‌فرض توصیه شده برای اکثر فروشگاه‌ها
- **12-24 ساعت:** برای محصولات خاص که نیاز به تصمیم‌گیری بیشتر دارند
- **2-7 روز:** فقط در موارد خاص (مثلاً محصولات گران قیمت)

### 2. مدیریت سبدهای رها شده
- بررسی منظم صفحه سبدهای رها شده (روزانه یا هفتگی)
- ارسال یادآوری به مشتریان با سبدهای ارزشمند
- استفاده از پاکسازی انبوه برای حذف سبدهای قدیمی

### 3. تحلیل داده‌ها
- بررسی نرخ تبدیل سبدهای رها شده
- شناسایی محصولاتی که بیشتر در سبدهای رها شده قرار می‌گیرند
- بهینه‌سازی قیمت‌گذاری بر اساس آمار سبدهای رها شده

## نکات امنیتی

### 1. احراز هویت
همه endpointهای مدیریتی نیاز به احراز هویت و دارا بودن نقش مناسب دارند:

```javascript
router.delete(
  '/admin/:cartId',
  protect,  // احراز هویت
  authorize('admin', 'manager', 'superadmin'),  // بررسی نقش
  deleteCartByAdmin,
)
```

### 2. اعتبارسنجی ورودی
- بررسی وجود سبد قبل از هرگونه عملیات
- اعتبارسنجی محدوده ساعت‌های TTL (0.5 تا 168)
- استفاده از transaction برای عملیات‌های حساس

## خطایابی

### مشکل: سبدها منقضی نمی‌شوند

**بررسی‌های لازم:**
1. وضعیت `autoExpireEnabled` در تنظیمات
2. مقدار `cartTTLHours` (باید بیشتر از 0 باشد)
3. زمان سرور (باید به درستی تنظیم شده باشد)

### مشکل: پاکسازی انبوه کار نمی‌کند

**بررسی‌های لازم:**
1. دسترسی کاربر (باید admin, manager, یا superadmin باشد)
2. وجود سبدهای واقعاً منقضی شده
3. خطاهای console و لاگ‌های سرور

## مثال‌های کاربردی

### تنظیم مهلت سبد برای محصول خاص

```javascript
// در صورت نیاز به مهلت متفاوت برای محصولات خاص
async function addSpecialProductToCart(productId, userId) {
  const cart = await Cart.findOne({ user: userId })
  // ... اضافه کردن محصول

  // تنظیم مهلت خاص (مثلاً 24 ساعت)
  cart.setExpiry(24)
  await cart.save()
}
```

### Job پاکسازی خودکار روزانه

```javascript
// استفاده از cron job برای پاکسازی روزانه
const cron = require('node-cron')

// هر روز ساعت 2 صبح
cron.schedule('0 2 * * *', async () => {
  console.log('شروع پاکسازی سبدهای منقضی شده...')

  const expiredCarts = await Cart.find({
    status: 'active',
    expiresAt: { $lte: new Date() },
    isExpired: false,
  })

  for (const cart of expiredCarts) {
    cart.isExpired = true
    cart.items = []
    cart.totalPrice = 0
    await cart.save()
  }

  console.log(`${expiredCarts.length} سبد خرید پاکسازی شد`)
})
```

## نتیجه‌گیری

این سیستم یک راهکار جامع و قابل تنظیم برای مدیریت انقضای سبدهای خرید ارائه می‌دهد که:

✅ قابل تنظیم از طریق پنل ادمین
✅ بهینه شده برای کارایی
✅ امن و دارای احراز هویت مناسب
✅ انعطاف‌پذیر برای نیازهای مختلف
✅ دارای ابزارهای مدیریتی قدرتمند

با استفاده صحیح از این سیستم، می‌توانید تجربه کاربری بهتری ارائه داده و در عین حال منابع سرور را به صورت بهینه مدیریت کنید.
